<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Somlink AI Camera</title>
<style>
  body { margin:0; background:black; color:white; font-family:sans-serif; overflow:hidden; }

  video {
    width:100%;
    height:100%;
    object-fit:contain; /* sida hadda */
    position:absolute;
    top:0;
    left:0;
    z-index:1;
    pointer-events:none;
    border-radius:0; /* ‚ñ° rectangle */
    background:black;
  }

  canvas#overlay, canvas#snapshot {
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
  }

  #flash { position:fixed; top:0; left:0; width:100%; height:100%; background:white; opacity:0; z-index:1500; transition:opacity 0.2s ease; }

  #controls {
    position:fixed;
    bottom:20px;
    width:100%;
    display:flex;
    justify-content:center;
    gap:20px;
    pointer-events:auto;
    z-index:9999;
  }
  button {
    background:rgba(0,0,0,0.6);
    color:white;
    border:none;
    border-radius:50%;
    padding:12px;
    font-size:18px;
    cursor:pointer;
  }

  #filtersMenu {
    position:fixed;
    right:20px;
    bottom:100px;
    display:none;
    flex-direction:column;
    gap:8px;
    background:rgba(0,0,0,0.8);
    padding:10px;
    border-radius:10px;
    pointer-events:auto;
    z-index:9999;
  }
  #filtersMenu.show { display:flex; animation:fadeIn .3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

  #galleryPanel {
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.95);
    display:none;
    flex-direction:column;
    align-items:center;
    overflow-y:auto;
    pointer-events:auto;
    z-index:9999;
  }
  #galleryPanel.show { display:flex; }
  #galleryPanel h2 { margin:10px; }
  #galleryGrid { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
  #galleryGrid div { position:relative; }
  #galleryGrid img, #galleryGrid video { width:110px; height:110px; object-fit:cover; border-radius:10px; border:2px solid white; }

  /* Preview with buttons */
  .preview {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }
  .preview-content {
    position: relative;
    background: #000;
    border-radius: 16px;
    overflow: hidden;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  .preview img, .preview video {
    max-width: 90vw;
    max-height: 80vh;
    display: block;
  }
  .preview button, .preview a {
    margin:8px 4px;
    padding:8px 16px;
    font-size:16px;
    border:none;
    border-radius:8px;
    cursor:pointer;
  }
  .download { background:white; color:black; }
  .delete { background:red; color:white; }
  .back { background:#555; color:white; }
</style>
</head>
<body>

<video id="camera" autoplay playsinline muted></video>
<canvas id="snapshot"></canvas>
<canvas id="overlay"></canvas>
<div id="flash"></div>

<div id="controls">
  <button id="flipBtn">üîÑ</button>
  <button id="filterBtn">üé®</button>
  <button id="captureBtn">üì∏</button>
  <button id="recordBtn">üé•</button>
  <button id="galleryBtn">üñºÔ∏è</button>
</div>

<div id="filtersMenu">
  <button data-filter="none">Normal</button>
  <button data-filter="grayscale(1)">Grayscale</button>
  <button data-filter="sepia(1)">Sepia</button>
  <button data-filter="brightness(1.4) contrast(1.2)">Bright</button>
  <button data-filter="contrast(1.3) saturate(1.3)">Vivid</button>
  <button data-filter="blur(2px)">Soft</button>
</div>

<div id="galleryPanel">
  <h2>üì∑ My Gallery</h2>
  <div id="galleryGrid"></div>
</div>

<script>
const video = document.getElementById('camera');
const canvas = document.getElementById('snapshot');
const overlay = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const overlayCtx = overlay.getContext('2d');
const flash = document.getElementById('flash');

let useFront = false; // rear camera default
let currentFilter = 'none';
let mediaRecorder, recordedChunks = [];
let isRecording = false;

// Start camera
async function startCamera(){
  if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
  const constraints = { video: { facingMode: useFront ? 'user' : 'environment' }, audio: false };
  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
  } catch(e) { alert("Camera error: " + e.message); }
}
startCamera();

document.getElementById('flipBtn').onclick = ()=>{ useFront=!useFront; startCamera(); };

// Filters
const filtersMenu = document.getElementById('filtersMenu');
document.getElementById('filterBtn').onclick = ()=>filtersMenu.classList.toggle('show');
filtersMenu.querySelectorAll('button').forEach(btn=>{
  btn.onclick=()=>{
    currentFilter = btn.getAttribute('data-filter');
    video.style.filter=currentFilter;
    filtersMenu.classList.remove('show');
  };
});

// Flash
function flashEffect(){ flash.style.opacity=0.8; setTimeout(()=>flash.style.opacity=0,150); }

// Gallery
const galleryPanel=document.getElementById('galleryPanel');
const galleryGrid=document.getElementById('galleryGrid');
document.getElementById('galleryBtn').onclick=()=>{ loadGallery(); galleryPanel.classList.add('show'); };

function loadGallery(){
  galleryGrid.innerHTML='';
  const photos = JSON.parse(localStorage.getItem('somlinkGallery')||'[]');
  photos.forEach((item,i)=>{
    const wrap=document.createElement('div');
    if(item.type==='photo'){
      const img=document.createElement('img'); img.src=item.data; wrap.appendChild(img);
      img.onclick=()=>showPreview(item.data,i,item.type);
    }else{
      const vid=document.createElement('video'); vid.src=item.data; vid.controls=false; wrap.appendChild(vid);
      vid.onclick=()=>showPreview(item.data,i,item.type);
    }
    galleryGrid.appendChild(wrap);
  });
}

// Capture
document.getElementById('captureBtn').onclick=()=>{
  flashEffect();
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  ctx.filter=currentFilter;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const dataURL=canvas.toDataURL('image/png');
  let gal=JSON.parse(localStorage.getItem('somlinkGallery')||'[]');
  gal.push({type:'photo',data:dataURL});
  localStorage.setItem('somlinkGallery',JSON.stringify(gal));
  loadGallery();
};

// Preview + Download + Delete + Back
function showPreview(data,i,type){
  const preview=document.createElement('div');
  preview.className='preview';
  preview.innerHTML=`
    <div class="preview-content">
      ${type==='photo'? `<img src="${data}">` : `<video src="${data}" autoplay controls></video>`}
      <div>
        <a href="${data}" download="Somlink_${Date.now()}" class="download">‚¨áÔ∏è Download</a>
        <button class="delete">üóëÔ∏è Delete</button>
        <button class="back">üîô Back</button>
      </div>
    </div>
  `;
  document.body.appendChild(preview);
  preview.querySelector('.delete').onclick=()=>{
    if(confirm('Ma hubtaa inaad tirtirayso sawirkan/muuqaalkan?')){
      let gal=JSON.parse(localStorage.getItem('somlinkGallery')||'[]');
      gal.splice(i,1);
      localStorage.setItem('somlinkGallery',JSON.stringify(gal));
      preview.remove();
      loadGallery();
    }
  };
  preview.querySelector('.back').onclick=()=>preview.remove();
}

// Video Record
document.getElementById('recordBtn').onclick=()=>{
  if(!isRecording) startRecord(); else stopRecord();
};
async function startRecord(){
  if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
  const constraints = { video: { facingMode: useFront ? 'user' : 'environment' }, audio: true };
  const stream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = stream;

  mediaRecorder = new MediaRecorder(stream);
  recordedChunks = [];
  mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
  mediaRecorder.onstop = saveVideo;
  mediaRecorder.start();

  isRecording = true;
  document.getElementById('recordBtn').textContent='‚èπÔ∏è';
}
function stopRecord(){
  mediaRecorder.stop();
  isRecording=false;
  document.getElementById('recordBtn').textContent='üé•';
  startCamera(); // dib ugu laabo camera aamusan
}
function saveVideo(){
  const blob=new Blob(recordedChunks,{type:'video/webm'});
  const url=URL.createObjectURL(blob);
  let gal=JSON.parse(localStorage.getItem('somlinkGallery')||'[]');
  gal.push({type:'video',data:url});
  localStorage.setItem('somlinkGallery',JSON.stringify(gal));
  alert('üéûÔ∏è Video saved to gallery!');
  loadGallery();
}

// AI Face Detection (optional)
</script>
</body>
</html>
