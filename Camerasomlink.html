<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Somlink Camera</title>
<style>
html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; font-family:sans-serif; }
#app { position:relative; width:100vw; height:100vh; overflow:hidden; display:flex; align-items:center; justify-content:center; }

video {
  position:absolute; top:0; left:0; width:100%; height:100%;
  object-fit:cover; /* Buuxin shaashadda */
  z-index:1; background:#000; transform-origin:center center;
}
#overlay { position:absolute; top:0; left:0; width:100%; height:100%; z-index:2; pointer-events:none; }

.top-right { position:absolute; top:16px; right:14px; display:flex; flex-direction:column; gap:10px; z-index:999; }
.bottom-center { position:absolute; bottom:18px; left:0; right:0; display:flex; justify-content:center; gap:18px; z-index:999; }

button {
  width:62px; height:62px; border-radius:50%; border:none; background:rgba(255,6,110,0.18);
  color:#fff; font-size:22px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,0.45); -webkit-tap-highlight-color:transparent;
}
button.small { width:46px; height:46px; font-size:18px; border-radius:12px; }

#filters { position:absolute; right:14px; bottom:100px; flex-direction:column; gap:8px; background:rgba(0,0,0,0.65); padding:8px; border-radius:10px; z-index:1000; display:none; }
#filters button { width:140px; border-radius:10px; font-size:14px; background:rgba(255,95,162,0.12); }

#galleryModal { position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:1000; display:none; flex-direction:column; align-items:center; padding:18px; overflow:auto; }
#galleryHeader { width:100%; display:flex; justify-content:space-between; align-items:center; color:#fff; margin-bottom:10px; }
#galleryGrid { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
.thumb { position:relative; width:110px; height:110px; border-radius:12px; overflow:hidden; border:2px solid rgba(255,255,255,0.12); }
.thumb img, .thumb video { width:100%; height:100%; object-fit:cover; display:block; }
.thumb button { position:absolute; top:6px; right:6px; background:crimson; border:0; color:#fff; width:26px; height:26px; border-radius:50%; font-size:14px; }
</style>
</head>
<body>
<div id="app">
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>

  <div class="top-right">
    <button id="flipBtn" title="Flip camera">üîÑ</button>
    <button id="flashBtn" class="small" title="Flash">‚ö°</button>
  </div>

  <div id="filters">
    <button data-filter="none">Normal</button>
    <button data-filter="grayscale(1)">Grayscale</button>
    <button data-filter="sepia(1)">Sepia</button>
    <button data-filter="contrast(1.3) saturate(1.2)">Vivid</button>
    <button data-filter="brightness(1.2)">Bright</button>
  </div>

  <div class="bottom-center">
    <button id="filtersBtn" title="Filters">üé®</button>
    <button id="captureBtn" title="Capture">üì∏</button>
    <button id="recordBtn" title="Record">‚è∫Ô∏è</button>
    <button id="galleryBtn" title="Gallery">üñºÔ∏è</button>
  </div>

  <div id="galleryModal">
    <div id="galleryHeader">
      <strong>Gallery</strong>
      <button id="closeGallery" class="small">‚úñ</button>
    </div>
    <div id="galleryGrid"></div>
  </div>
</div>

<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const overlayCtx = overlay.getContext('2d');
let useFront = true, mediaRecorder=null, recordedChunks=[], isRecording=false;
let currentFilter='none';

/* Camera setup */
async function getDeviceId(front){
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d=>d.kind==='videoinput');
  if(!cams.length) return null;
  if(front) return cams[0].deviceId;
  return cams[cams.length-1].deviceId;
}
async function startCamera(){
  if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
  const vw = window.innerWidth, vh=window.innerHeight;
  const deviceId = await getDeviceId(useFront);
  const constraints = {
    video: deviceId ? { deviceId:{exact:deviceId}, width:{ideal:vw}, height:{ideal:vh}, aspectRatio:vw/vh } :
                      { facingMode:useFront?'user':'environment', width:{ideal:vw}, height:{ideal:vh}, aspectRatio:vw/vh },
    audio:false
  };
  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    video.style.transform = useFront ? 'scaleX(-1)' : 'scaleX(1)';
    overlay.style.transform = video.style.transform;
    video.onloadedmetadata=()=>{ overlay.width=video.videoWidth; overlay.height=video.videoHeight; };
  } catch(e){ alert('Camera access failed: '+e.message); }
}

/* Flip */
document.getElementById('flipBtn').onclick = async ()=>{ useFront = !useFront; await startCamera(); };

/* Filters */
document.getElementById('filtersBtn').onclick = ()=>{ 
  const f = document.getElementById('filters'); 
  f.style.display = (f.style.display==='flex'?'none':'flex'); 
};
document.querySelectorAll('#filters button').forEach(b=>{
  b.onclick=()=>{ currentFilter=b.getAttribute('data-filter'); video.style.filter=currentFilter; document.getElementById('filters').style.display='none'; };
});

/* Capture */
const canvas = document.createElement('canvas');
document.getElementById('captureBtn').onclick = ()=>{
  if(!video.videoWidth||!video.videoHeight) return;
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  const ctx=canvas.getContext('2d');
  if(useFront){ ctx.save(); ctx.scale(-1,1); ctx.filter=currentFilter; ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height); ctx.restore(); }
  else { ctx.filter=currentFilter; ctx.drawImage(video,0,0,canvas.width,canvas.height); }
  const data = canvas.toDataURL('image/png');
  const gal = JSON.parse(localStorage.getItem('somlinkGallery')||'[]');
  gal.push({id:Date.now(),type:'photo',data});
  localStorage.setItem('somlinkGallery',JSON.stringify(gal));
  alert('Sawir la keydiyey gallery-ga!');
};

/* Recording */
document.getElementById('recordBtn').onclick = ()=>{
  if(!isRecording) startRecording(); else stopRecording();
};
function startRecording(){
  if(!video.srcObject){ alert('Camera not ready'); return; }
  recordedChunks=[];
  try{ mediaRecorder = new MediaRecorder(video.srcObject,{mimeType:'video/webm;codecs=vp8'}); }
  catch(e){ try{ mediaRecorder=new MediaRecorder(video.srcObject);}catch(err){ alert('Recording not supported'); return; } }
  mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) recordedChunks.push(e.data); };
  mediaRecorder.onstop=()=>{
    const blob=new Blob(recordedChunks,{type:'video/webm'});
    const url=URL.createObjectURL(blob);
    const gal=JSON.parse(localStorage.getItem('somlinkGallery')||'[]');
    gal.push({id:Date.now(),type:'video',data:url});
    localStorage.setItem('somlinkGallery',JSON.stringify(gal));
    alert('Video la keydiyey gallery-ga!');
  };
  mediaRecorder.start();
  isRecording=true;
  document.getElementById('recordBtn').textContent='‚èπÔ∏è';
}
function stopRecording(){ if(mediaRecorder&&mediaRecorder.state!=='inactive') mediaRecorder.stop(); isRecording=false; document.getElementById('recordBtn').textContent='‚è∫Ô∏è'; }

/* Gallery */
document.getElementById('galleryBtn').onclick = loadAndOpenGallery;
document.getElementById('closeGallery').onclick = ()=>{ document.getElementById('galleryModal').style.display='none'; };
function loadAndOpenGallery(){
  const grid=document.getElementById('galleryGrid'); grid.innerHTML='';
  const gal=JSON.parse(localStorage.getItem('somlinkGallery')||'[]');
  if(!gal.length){ grid.innerHTML='<p style="color:#ccc">Gallery waa faaran</p>'; }
  gal.forEach(item=>{
    const div=document.createElement('div'); div.className='thumb';
    if(item.type==='photo'){ const img=document.createElement('img'); img.src=item.data; div.appendChild(img); }
    else if(item.type==='video'){ const vid=document.createElement('video'); vid.src=item.data; vid.controls=true; div.appendChild(vid); }
    const delBtn=document.createElement('button'); delBtn.textContent='‚úñ'; delBtn.onclick=()=>{ deleteItem(item.id); };
    div.appendChild(delBtn);
    grid.appendChild(div);
  });
  document.getElementById('galleryModal').style.display='flex';
}
function deleteItem(id){
  let gal=JSON.parse(localStorage.getItem('somlinkGallery')||'[]');
  gal=gal.filter(x=>x.id!==id);
  localStorage.setItem('somlinkGallery',JSON.stringify(gal));
  loadAndOpenGallery();
}

/* Flash */
document.getElementById('flashBtn').onclick = ()=>{
  const flash = document.createElement('div');
  flash.style.position='fixed';
  flash.style.top='0'; flash.style.left='0'; flash.style.width='100%'; flash.style.height='100%';
  flash.style.background='white'; flash.style.opacity='0.8'; flash.style.zIndex='9999';
  document.body.appendChild(flash);
  setTimeout(()=>{ flash.remove(); },120);
}

/* Start camera on load */
startCamera();
</script>
</body>
  </html>
